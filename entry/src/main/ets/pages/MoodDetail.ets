import { router } from '@kit.ArkUI';
import MoodData from '../model/MoodData';

interface MoodItem {
  icon: string;
  name: string;
}

@Entry
@Component
struct MoodDetail {
  // æ¥æ”¶ä»ä¸Šä¸€é¡µä¼ è¿‡æ¥çš„æ•°æ®
  @State moodData: MoodData = router.getParams() as MoodData;

  // å¿ƒæƒ…é…ç½® (ç”¨äºæ˜¾ç¤ºå›¾æ ‡å’Œåå­—)
  private moods: MoodItem[] = [
    { icon: 'ğŸ˜„', name: 'å¼€å¿ƒ' },
    { icon: 'ğŸ˜', name: 'å¹³é™' },
    { icon: 'ğŸ˜°', name: 'ç„¦è™‘' },
    { icon: 'ğŸ˜¢', name: 'ä¼¤å¿ƒ' },
    { icon: 'ğŸ˜¡', name: 'ç”Ÿæ°”' },
    { icon: 'ğŸ˜´', name: 'ç–²æƒ«' },
    { icon: 'ğŸ¤©', name: 'å…´å¥‹' },
    { icon: 'ğŸ¤¯', name: 'çƒ¦èº' }
  ];

  // æ ¼å¼åŒ–æ—¥æœŸï¼š2025å¹´12æœˆ26æ—¥ æ˜ŸæœŸäº” 08:30
  formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
    const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    return `${dateStr} ${timeStr}`;
  }

  // è·å–åˆ†æ•°é¢œè‰²
  getScoreColor(score: number): string {
    if (score >= 8) return '#FF9800'; // æ©™
    if (score >= 5) return '#2196F3'; // è“
    return '#9E9E9E'; // ç°
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ  (é€æ˜èƒŒæ™¯)
      Row() {
        // è¿”å›æŒ‰é’®
        Column() {
          Text('ğŸ‘ˆ').fontSize(24)
        }
        .width(40)
        .height(40)
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          router.back();
        })

        Text('æ—¥è®°è¯¦æƒ…')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Blank().width(40) // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
      }
      .width('100%')
      .padding({ top: 10, bottom: 10, left: 10, right: 10 })

      // 2. å†…å®¹æ»šåŠ¨åŒº
      Scroll() {
        Column() {
          // --- A. å¤´éƒ¨å¡ç‰‡ (æ—¥æœŸ+å¿ƒæƒ…) ---
          Column() {
            Text(this.formatDate(this.moodData.date))
              .fontSize(14)
              .fontColor('#666')
              .margin({ bottom: 15 })

            Row() {
              // å·¦è¾¹ï¼šå¤§è¡¨æƒ…
              Column() {
                Text(this.moods[this.moodData.moodType].icon).fontSize(60)
                Text(this.moods[this.moodData.moodType].name)
                  .fontSize(16)
                  .fontColor('#666')
                  .margin({ top: 5 })
              }

              Blank().width(30)

              // å³è¾¹ï¼šå¼ºåº¦åˆ†æ•°
              Column() {
                Text(this.moodData.moodScore.toString())
                  .fontSize(40)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.getScoreColor(this.moodData.moodScore))
                Text('å¿ƒæƒ…æŒ‡æ•°')
                  .fontSize(12)
                  .fontColor('#999')
              }
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({ bottom: 20 })

            // åŸå› æ°”æ³¡
            if (this.moodData.reason) {
              Text(this.moodData.reason)
                .fontSize(16)
                .fontColor('#333')
                .backgroundColor('rgba(0,0,0,0.05)')
                .padding({ left: 15, right: 15, top: 10, bottom: 10 })
                .borderRadius(20)
            }
          }
          .width('90%')
          .backgroundColor('#FFFFFF')
          .borderRadius(24)
          .padding(20)
          .shadow({ radius: 20, color: 'rgba(0,0,0,0.05)', offsetY: 10 })
          .margin({ top: 10, bottom: 20 })

          // --- B. å®Œæ•´æ—¥è®°å†…å®¹ ---
          if (this.moodData.diaryContent) {
            Column() {
              Text('ğŸ“ æ—¥è®°å†…å®¹')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .width('100%')
                .margin({ bottom: 15 })

              // è¿™é‡Œçš„ Text ä¼šè‡ªåŠ¨æ¢è¡Œï¼Œæ˜¾ç¤ºå®Œæ•´å†…å®¹
              Text(this.moodData.diaryContent)
                .fontSize(16)
                .fontColor('#333')
                .lineHeight(26) // å¢åŠ è¡Œé«˜ï¼Œé˜…è¯»æ›´èˆ’æœ
                .width('100%')
            }
            .width('90%')
            .backgroundColor('#FFFFFF')
            .borderRadius(24)
            .padding(20)
            .shadow({ radius: 20, color: 'rgba(0,0,0,0.05)', offsetY: 10 })
            .margin({ bottom: 20 })
          }

          // --- C. å›¾ç‰‡å±•ç¤ºåŒº ---
          if (this.moodData.images && this.moodData.images.length > 0) {
            Column() {
              Text('ğŸ“· ç…§ç‰‡å›å¿†')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .width('100%')
                .margin({ bottom: 15 })

              ForEach(this.moodData.images.split(',').filter(p => p !== ''), (img: string) => {
                Image(img)
                  .width('100%')
                  .borderRadius(12)
                  .margin({ bottom: 10 })
                  .objectFit(ImageFit.Cover)
              })
            }
            .width('90%')
            .backgroundColor('#FFFFFF')
            .borderRadius(24)
            .padding(20)
            .shadow({ radius: 20, color: 'rgba(0,0,0,0.05)', offsetY: 10 })
            .margin({ bottom: 40 })
          }
        }
        .width('100%')
      }
      .layoutWeight(1) // å æ»¡å‰©ä½™ç©ºé—´
      .scrollBar(BarState.Off)
    }
    .height('100%')
    .width('100%')
    // ä¿æŒç»Ÿä¸€çš„æ¸å˜èƒŒæ™¯
    .linearGradient({
      direction: GradientDirection.Top,
      colors: [['#E3F2FD', 0.0], ['#F3E5F5', 1.0]]
    })
  }
}