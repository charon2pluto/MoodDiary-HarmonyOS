import { router } from '@kit.ArkUI';
import MoodDB from '../utils/MoodDB';
import MoodData from '../model/MoodData';

interface MoodItem {
  icon: string;
  name: string;
}

@Entry
@Component
struct MoodHistory {
  @State historyList: MoodData[] = []; // åŽŸå§‹å®Œæ•´æ•°æ®
  @State filteredList: MoodData[] = []; // æœç´¢ç­›é€‰åŽçš„æ•°æ®
  @State searchText: string = ''; // æœç´¢å…³é”®è¯

  private moods: MoodItem[] = [
    { icon: 'ðŸ˜„', name: 'å¼€å¿ƒ' },
    { icon: 'ðŸ˜', name: 'å¹³é™' },
    { icon: 'ðŸ˜°', name: 'ç„¦è™‘' },
    { icon: 'ðŸ˜¢', name: 'ä¼¤å¿ƒ' },
    { icon: 'ðŸ˜¡', name: 'ç”Ÿæ°”' },
    { icon: 'ðŸ˜´', name: 'ç–²æƒ«' },
    { icon: 'ðŸ¤©', name: 'å…´å¥‹' },
    { icon: 'ðŸ¤¯', name: 'çƒ¦èº' }
  ];

  onPageShow() {
    this.loadData();
  }

  loadData() {
    MoodDB.queryAll().then((data) => {
      this.historyList = data;
      this.applyFilter(); // åŠ è½½åŽç«‹å³åº”ç”¨ç­›é€‰ï¼ˆé»˜è®¤ä¸ºå…¨éƒ¨ï¼‰
    });
  }

  // â˜… æ ¸å¿ƒé€»è¾‘ï¼šæ‰§è¡Œç­›é€‰
  applyFilter() {
    if (this.searchText.trim() === '') {
      this.filteredList = this.historyList;
    } else {
      const keyword = this.searchText.toLowerCase();
      this.filteredList = this.historyList.filter(item =>
      // æœç´¢èŒƒå›´ï¼šåŽŸå› æ–‡å­— æˆ– æ—¥è®°æ­£æ–‡
      item.reason.toLowerCase().includes(keyword) ||
      item.diaryContent.toLowerCase().includes(keyword)
      );
    }
  }

  formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
  }

  getScoreColor(score: number): string {
    if (score >= 8) return '#FF9800';
    if (score >= 5) return '#2196F3';
    return '#9E9E9E';
  }

  build() {
    Column() {
      // --- 1. é¡¶éƒ¨å¯¼èˆªæ  ---
      Row() {
        Column() {
          Text('ðŸ‘ˆ').fontSize(24)
        }
        .width(40)
        .height(40)
        .justifyContent(FlexAlign.Center)
        .onClick(() => router.back())

        Text('å¿ƒæƒ…æ—¶å…‰è½´')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Text('ðŸ“Š')
          .fontSize(24)
          .width(40)
          .textAlign(TextAlign.Center)
          .onClick(() => {
            router.pushUrl({ url: 'pages/MoodStatistics' })
          })
      }
      .width('100%')
      .padding({ left: 10, right: 10, top: 15, bottom: 10 })
      .backgroundColor('#FFFFFF')

      // --- 2. â˜… æ–°å¢žï¼šæœç´¢æ¡†åŒºåŸŸ ---
      Search({ value: this.searchText, placeholder: 'æœç´¢å¿ƒæƒ…åŽŸå› æˆ–æ—¥è®°...' })
        .width('90%')
        .height(40)
        .backgroundColor('#FFF')
        .margin({ bottom: 15, top: 5 })
        .onChange((value: string) => {
          this.searchText = value;
          this.applyFilter(); // è¾“å…¥å˜åŒ–æ—¶å®žæ—¶ç­›é€‰
        })

      // --- 3. åˆ—è¡¨åŒºåŸŸ ---
      if (this.filteredList.length === 0) {
        Column() {
          Text(this.searchText ? 'ðŸ”' : 'ðŸ“­').fontSize(60).margin({ bottom: 20 })
          Text(this.searchText ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®°å½•' : 'è¿˜æ²¡æœ‰è®°å½•ï¼Œå¿«åŽ»å†™ä¸€ç¯‡å§~').fontColor('#999')
        }.width('100%').margin({ top: 100 })
      } else {
        List({ space: 15 }) {
          ForEach(this.filteredList, (item: MoodData) => {
            ListItem() {
              Column() {
                // é¡¶éƒ¨ï¼šæ—¥æœŸ + åˆ†æ•°
                Row() {
                  Text(this.formatDate(item.date))
                    .fontSize(14)
                    .fontColor('#999')
                  Blank()
                  Text(item.moodScore + 'åˆ†')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(this.getScoreColor(item.moodScore))
                }
                .width('100%')
                .margin({ bottom: 10 })

                // ä¸­é—´ï¼šEmoji + åŽŸå› 
                Row() {
                  Text(this.moods[item.moodType] ? this.moods[item.moodType].icon : 'â“')
                    .fontSize(40)
                    .margin({ right: 15 })

                  if (item.reason) {
                    Text(item.reason)
                      .fontSize(16)
                      .fontColor('#333')
                      .backgroundColor('#F5F7F9')
                      .padding(10)
                      .borderRadius(10)
                      .layoutWeight(1)
                  }
                }
                .width('100%')
                .alignItems(VerticalAlign.Top)

                // æ—¥è®°æ‘˜è¦
                if (item.diaryContent) {
                  Text(item.diaryContent)
                    .fontSize(15)
                    .fontColor('#555')
                    .margin({ top: 10 })
                    .lineHeight(22)
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .width('100%')
                }
              }
              .width('100%')
              .padding(15)
              .backgroundColor('#FFFFFF')
              .borderRadius(16)
              .shadow({ radius: 10, color: '#08000000', offsetY: 2 })
              .onClick(() => {
                router.pushUrl({
                  url: 'pages/MoodDetail',
                  params: item
                });
              })
            }
          })
        }
        .width('95%')
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .height('100%')
    .width('100%')
    .backgroundColor('#F5F5F5')
  }
}