import { router } from '@kit.ArkUI';
import MoodDB from '../utils/MoodDB';
import MoodData from '../model/MoodData';
import { BusinessError } from '@kit.BasicServicesKit';
import { common } from '@kit.AbilityKit';

// 1. åˆå§‹åŒ–æŒä¹…åŒ–æ•°æ®
PersistentStorage.persistProp('dailyQuoteDate', '');
PersistentStorage.persistProp('dailyQuoteContent', '');

interface MoodItem {
  icon: string;
  name: string;
}

@Entry
@Component
struct Index {
  // --- æ•°æ®æº ---
  private moods: MoodItem[] = [
    { icon: 'ğŸ˜„', name: 'å¼€å¿ƒ' },
    { icon: 'ğŸ˜', name: 'å¹³é™' },
    { icon: 'ğŸ˜°', name: 'ç„¦è™‘' },
    { icon: 'ğŸ˜¢', name: 'ä¼¤å¿ƒ' },
    { icon: 'ğŸ˜¡', name: 'ç”Ÿæ°”' },
    { icon: 'ğŸ˜´', name: 'ç–²æƒ«' },
    { icon: 'ğŸ¤©', name: 'å…´å¥‹' },
    { icon: 'ğŸ¤¯', name: 'çƒ¦èº' }
  ];

  // è¯­å½•åº“
  private quotes: string[] = [
    "å¿ƒè‹¥å‘é˜³ï¼Œæ— ç•æ‚²ä¼¤ã€‚",
    "ç”Ÿæ´»åŸæœ¬æ²‰é—·ï¼Œä½†è·‘èµ·æ¥å°±æœ‰é£ã€‚",
    "ä¸‡ç‰©çš†æœ‰è£‚ç—•ï¼Œé‚£æ˜¯å…‰ç…§è¿›æ¥çš„åœ°æ–¹ã€‚",
    "çƒ­çˆ±å¯æŠµå²æœˆæ¼«é•¿ã€‚",
    "ä¿æŒçƒ­çˆ±ï¼Œå¥”èµ´å±±æµ·ã€‚",
    "æ˜Ÿå…‰ä¸é—®èµ¶è·¯äººï¼Œæ—¶å…‰ä¸è´Ÿæœ‰å¿ƒäººã€‚",
    "ä½ è‹¥ç››å¼€ï¼Œè´è¶è‡ªæ¥ã€‚",
    "å¥½å¥½ç”Ÿæ´»ï¼Œæ…¢æ…¢ç›¸é‡ã€‚",
    "å‡¡æ˜¯è¿‡å¾€ï¼Œçš†ä¸ºåºç« ã€‚",
    "äººç”Ÿæ²¡æœ‰ç™½èµ°çš„è·¯ï¼Œæ¯ä¸€æ­¥éƒ½ç®—æ•°ã€‚"
  ];

  // --- çŠ¶æ€å˜é‡ ---
  @State currentDate: string = '';
  @State selectedMoodIndex: number = -1;
  @State moodScore: number = 5;
  @State reasonText: string = '';

  @State miniChartPoints: number[][] = [];
  @State hasHistory: boolean = false;

  // --- è¯­å½•ç›¸å…³çŠ¶æ€ ---
  @StorageLink('dailyQuoteDate') appQuoteDate: string = '';
  @StorageLink('dailyQuoteContent') appQuoteContent: string = '';
  @State todayQuote: string = '';

  aboutToAppear() {
    const date = new Date();
    this.currentDate = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;

    let context = getContext(this) as common.UIAbilityContext;
    MoodDB.init(context).then(() => {
      console.log('ğŸ‰ ä¸»é¡µï¼šæ•°æ®åº“è¿æ¥æˆåŠŸï¼');
      this.loadMiniChart();
    }).catch((err: Error) => {
      console.error('ğŸ˜­ ä¸»é¡µï¼šæ•°æ®åº“è¿æ¥å¤±è´¥', err);
    });

    // ç”Ÿæˆä»Šæ—¥è¯­å½•
    this.generateDailyQuote();
  }

  onPageShow() {
    this.loadMiniChart();
  }

  // â˜…â˜…â˜… ä¿®æ”¹ç‚¹1ï¼šé€»è¾‘æ”¹ä¸ºâ€œæ¯æ¬¡éƒ½åˆ·æ–°â€ â˜…â˜…â˜…
  generateDailyQuote() {
    // ä¹‹å‰æˆ‘ä»¬åˆ¤æ–­äº†æ—¥æœŸï¼Œç°åœ¨ç›´æ¥ç§»é™¤åˆ¤æ–­ï¼Œæ¯æ¬¡è¿›æ¥éƒ½éšæœº
    const index = Math.floor(Math.random() * this.quotes.length);
    const newQuote = this.quotes[index];

    // æ›´æ–°æ˜¾ç¤º
    this.todayQuote = newQuote;

    // é¡ºä¾¿æ›´æ–°ä¸€ä¸‹æœ¬åœ°å­˜å‚¨ï¼ˆè™½ç„¶ç°åœ¨ä¸ä¾èµ–å®ƒæ¥â€œé”ä½â€è¯­å½•äº†ï¼Œä½†ä¿æŒæ•°æ®æœ€æ–°ä¹Ÿä¸é”™ï¼‰
    this.appQuoteContent = newQuote;
    this.appQuoteDate = new Date().toDateString();
  }

  loadMiniChart() {
    MoodDB.queryAll().then((data) => {
      if (data.length > 0) {
        this.hasHistory = true;
        let recent = data.slice(0, 7).reverse();

        let width = 300;
        let height = 50;
        let stepX = width / (recent.length - 1 || 1);

        this.miniChartPoints = recent.map((item, index) => {
          let x = index * stepX;
          let y = height - (item.moodScore / 10 * height);
          return [x, y];
        });
      } else {
        this.hasHistory = false;
      }
    });
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨æ—¥æœŸä¸è®¾ç½®
      Column() {
        Row() {
          Text(this.currentDate)
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')

          Blank()

          Text('âš™ï¸')
            .fontSize(24)
            .onClick(() => {
              router.pushUrl({ url: 'pages/SettingsPage' });
            })
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)

        Text('ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ')
          .fontSize(16)
          .fontColor('#666')
          .margin({ top: 5 })
          .width('100%')
      }
      .padding({ top: 50, left: 24, right: 24, bottom: 20 })

      // 2. æ ¸å¿ƒå†…å®¹åŒº
      Scroll() {
        Column() {

          // --- å¡ç‰‡: ä»Šæ—¥è¯­å½• ---
          Stack({ alignContent: Alignment.TopStart }) {
            // è£…é¥°ç”¨çš„åŒå¼•å· (é…åˆç±³è‰²èƒŒæ™¯ï¼Œæ¢æˆæ·¡é‡‘è‰²æˆ–æ·¡æ£•è‰²)
            Text('â€œ')
              .fontSize(60)
              .fontColor('rgba(200, 180, 150, 0.4)') // æ·¡é‡‘æ£•è‰²ï¼Œæ›´æœ‰è´¨æ„Ÿ
              .position({ x: 10, y: -10 })
              .fontFamily('HarmonyOS Sans')

            Text(this.todayQuote)
              .fontSize(15)
              .fontColor('#5D4037') // â˜… æ–‡å­—æ¢æˆæ·±è¤è‰²ï¼Œæ¯”çº¯é»‘æ›´æŸ”å’Œï¼Œåƒæ‰“å°çš„å­—
              .fontStyle(FontStyle.Italic)
              .lineHeight(24)
              .width('100%')
              .padding({ left: 40, right: 20, top: 15, bottom: 15 })
          }
          .width('90%')
          // â˜…â˜…â˜… ä¿®æ”¹ç‚¹ï¼šæ¢æˆæ¸©æš–ç±³æè‰² â˜…â˜…â˜…
          .backgroundColor('#FEF9E7')
          .borderRadius(16)
          .margin({ bottom: 20 })
          // é˜´å½±ä¹Ÿæ¢æˆæš–è‰²è°ƒï¼Œæ˜¾å¾—å¾ˆæš–
          .shadow({ radius: 10, color: 'rgba(200, 180, 150, 0.3)', offsetY: 5 })
          .border({ width: 1, color: '#FFF' }) // åŠ ä¸ªç™½è¾¹ï¼Œåƒå¡ç‰‡ä¸€æ ·

          // --- å¡ç‰‡ A: å¿ƒæƒ…è¶‹åŠ¿å°é¢„è§ˆ ---
          if (this.hasHistory) {
            Column() {
              Row() {
                Text('æƒ…ç»ªèµ°åŠ¿').fontSize(14).fontWeight(FontWeight.Bold).fontColor('#333')
                Blank()
                Text('æœ€è¿‘7æ¡').fontSize(12).fontColor('#999')
              }.width('100%').margin({ bottom: 10 })

              Stack({ alignContent: Alignment.Center }) {
                Divider().color('rgba(0,0,0,0.05)').width('100%')

                Polyline()
                  .points(this.miniChartPoints)
                  .fill('none')
                  .stroke('#7B61FF')
                  .strokeWidth(2)
                  .width('100%')
                  .height(50)
              }
              .height(50)
              .width('100%')
            }
            .width('90%')
            .linearGradient({
              direction: GradientDirection.Right,
              colors: [['#E3F2FD', 0.0], ['#F3E5F5', 1.0]]
            })
            .borderRadius(16)
            .padding(15)
            .margin({ bottom: 15 })
          }

          // --- å¡ç‰‡ B: Emoji é€‰æ‹©ç½‘æ ¼ ---
          Column() {
            Grid() {
              ForEach(this.moods, (item: MoodItem, index: number) => {
                GridItem() {
                  Column() {
                    Text(item.icon).fontSize(32)
                    Text(item.name).fontSize(12).fontColor(this.selectedMoodIndex === index ? '#7B61FF' : '#999').margin({ top: 5 })
                  }
                  .width(60)
                  .height(70)
                  .justifyContent(FlexAlign.Center)
                  .borderRadius(12)
                  .backgroundColor(this.selectedMoodIndex === index ? '#F2EFFF' : 'transparent')
                  .border({ width: 1, color: this.selectedMoodIndex === index ? '#7B61FF' : 'transparent' })
                  .scale(this.selectedMoodIndex === index ? { x: 1.1, y: 1.1 } : { x: 1, y: 1 })
                  .animation({ duration: 300, curve: Curve.EaseOut })
                  .onClick(() => {
                    this.selectedMoodIndex = index;
                  })
                }
              })
            }
            .columnsTemplate('1fr 1fr 1fr 1fr')
            .rowsGap(10)
            .height(170)
            .width('100%')
          }
          .width('90%')
          .backgroundColor('#FFFFFF')
          .borderRadius(24)
          .padding(15)
          .shadow({ radius: 20, color: 'rgba(0, 0, 0, 0.08)', offsetY: 5 })
          .border({ width: 1, color: '#F0F0F0' })

          // --- å¡ç‰‡ C: è¯¦ç»†è®°å½•åŒº ---
          if (this.selectedMoodIndex !== -1) {
            Column() {
              Row() {
                Text('å¼ºåº¦').fontSize(14).fontColor('#666')
                Blank()
                Text(this.moodScore.toFixed(0)).fontSize(18).fontWeight(FontWeight.Bold).fontColor('#7B61FF')
              }.width('100%').margin({ bottom: 5 })

              Slider({
                value: this.moodScore,
                min: 1,
                max: 10,
                step: 1,
                style: SliderStyle.OutSet
              })
                .blockColor('#7B61FF')
                .trackColor('#E0E0E0')
                .selectedColor('#7B61FF')
                .showSteps(true)
                .onChange((value: number) => {
                  this.moodScore = value;
                })
                .width('100%')

              Divider().margin({ top: 15, bottom: 15 }).color('#F5F5F5')

              TextInput({ placeholder: 'å†™ä¸€å¥ç®€çŸ­çš„åŸå› ...' })
                .placeholderColor('#CCC')
                .fontSize(14)
                .caretColor('#7B61FF')
                .width('100%')
                .height(40)
                .backgroundColor('transparent')
                .onChange((value) => {
                  this.reasonText = value;
                })

              Button('âœ¨ è®°å½•æ­¤åˆ»', { type: ButtonType.Capsule })
                .width('100%')
                .height(45)
                .backgroundColor('#7B61FF')
                .margin({ top: 20 })
                .shadow({ radius: 10, color: 'rgba(123, 97, 255, 0.4)', offsetY: 5 })
                .onClick(() => {
                  this.saveData();
                })
            }
            .width('90%')
            .backgroundColor('#FFFFFF')
            .borderRadius(24)
            .padding(20)
            .margin({ top: 15 })
            .shadow({ radius: 20, color: 'rgba(0, 0, 0, 0.08)', offsetY: 5 })
            .border({ width: 1, color: '#F0F0F0' })
            .transition({ type: TransitionType.Insert, opacity: 0, translate: { y: 20 } })
          }

          Blank().height(100)
        }
        .width('100%')
      }
      .scrollBar(BarState.Off)
      .layoutWeight(1)

      // 3. åº•éƒ¨æ‚¬æµ®æŒ‰é’®æ 
      Row() {
        // å†™æ—¥è®°æŒ‰é’®
        Column() {
          Button({ type: ButtonType.Circle }) {
            Text('âœï¸')
              .fontSize(28)
              .fontColor('#FFF')
          }
          .width(56)
          .height(56)
          .backgroundColor('#FF9800')
          .shadow({ radius: 10, color: 'rgba(255, 152, 0, 0.4)', offsetY: 5 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/DiaryEdit' });
          })
          Text('å†™æ—¥è®°').fontSize(11).fontColor('#666').margin({ top: 4 })
        }.margin({ right: 60 })

        // çœ‹è¶³è¿¹æŒ‰é’®
        Column() {
          Button({ type: ButtonType.Circle }) {
            Text('ğŸ“…')
              .fontSize(26)
              .fontColor('#FFF')
          }
          .width(56)
          .height(56)
          .backgroundColor('#00BCD4')
          .shadow({ radius: 10, color: 'rgba(0, 188, 212, 0.4)', offsetY: 5 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/MoodHistory' });
          })
          Text('çœ‹è¶³è¿¹').fontSize(11).fontColor('#666').margin({ top: 4 })
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ bottom: 20 })
    }
    .height('100%')
    .width('100%')
    .backgroundColor('#FFFFFF')
  }

  saveData() {
    let newMood = new MoodData(
      0,
      MoodDB.currentUserId,
      new Date().getTime(),
      this.selectedMoodIndex,
      this.moodScore,
      this.reasonText,
      '',
      ''
    );

    MoodDB.insert(newMood).then((id) => {
      AlertDialog.show({ message: 'âœ¨ è®°å½•æˆåŠŸï¼' });
      this.loadMiniChart();
      this.selectedMoodIndex = -1;
      this.reasonText = '';
      this.moodScore = 5;
    }).catch((err: BusinessError) => {
      AlertDialog.show({ message: 'ä¿å­˜å¤±è´¥: ' + err.message });
    });
  }
}