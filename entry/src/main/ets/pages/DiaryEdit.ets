import { router } from '@kit.ArkUI';
import MoodDB from '../utils/MoodDB';
import MoodData from '../model/MoodData';
import { BusinessError } from '@kit.BasicServicesKit';

@Entry
@Component
struct DiaryEdit {
  @State diaryContent: string = '';
  @State selectedImages: string[] = []; // æš‚æœªå®ç°çœŸå®ç›¸å†Œï¼Œé¢„ç•™

  // â˜… æ–°å¢çŠ¶æ€ï¼šä»Šå¤©çš„å¤šæ¡å¿ƒæƒ…
  @State todayMoods: MoodData[] = [];
  @State currentMood: MoodData | null = null; // å½“å‰é€‰ä¸­çš„é‚£ä¸€æ¡
  @State selectedIndex: number = 0; // ä¸‹æ‹‰æ¡†é€‰ä¸­çš„ç´¢å¼•

  // æ˜ å°„ Emoji ç”¨äºæ˜¾ç¤º
  private moodIcons: string[] = ['ğŸ˜„', 'ğŸ˜', 'ğŸ˜°', 'ğŸ˜¢', 'ğŸ˜¡', 'ğŸ˜´', 'ğŸ¤©', 'ğŸ¤¯'];

  aboutToAppear() {
    this.loadTodayMoods();
  }

  loadTodayMoods() {
    // æ”¹ç”¨ queryTodayAll è·å–æ‰€æœ‰è®°å½•
    MoodDB.queryTodayAll().then((list) => {
      this.todayMoods = list;

      if (list.length > 0) {
        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€æ¡ï¼ˆæœ€æ–°çš„ï¼‰
        this.selectMood(0);
      }
    });
  }

  // åˆ‡æ¢å¿ƒæƒ…è®°å½•æ—¶çš„é€»è¾‘
  selectMood(index: number) {
    this.selectedIndex = index;
    this.currentMood = this.todayMoods[index];
    // â˜… å…³é”®ï¼šåˆ‡æ¢æ—¶ï¼Œè¦æŠŠè¿™æ¡å¿ƒæƒ…é‡Œå·²æœ‰çš„æ—¥è®°å†…å®¹å¡«è¿›å»
    this.diaryContent = this.currentMood.diaryContent || '';
  }

  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º (ä¾‹å¦‚ 10:30)
  formatTime(timestamp: number): string {
    let date = new Date(timestamp);
    return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆª
      Row() {
        Text('å–æ¶ˆ')
          .fontSize(16)
          .fontColor('#666')
          .onClick(() => router.back())

        Text('å†™æ—¥è®°')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)

        Text('ä¿å­˜')
          .fontSize(16)
          .fontColor('#7B61FF')
          .onClick(() => this.saveDiary())
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding(20)
      .backgroundColor('#FFF')

      // 2. â˜… æ ¸å¿ƒæ”¹è¿›ï¼šå¿ƒæƒ…é€‰æ‹©åŒº
      if (this.todayMoods.length > 0) {
        Row() {
          Text('å…³è”è®°å½•ï¼š').fontSize(14).fontColor('#666')

          // ä¸‹æ‹‰é€‰æ‹©æ¡†
          Select(this.todayMoods.map((item) => {
            // æ„å»ºé€‰é¡¹æ–‡æœ¬ï¼š 10:30 ğŸ˜„ (8åˆ†)
            let text = `${this.formatTime(item.date)} ${this.moodIcons[item.moodType] || 'â“'} (${item.moodScore}åˆ†)`;
            return { value: text } as SelectOption;
          }))
            .selected(this.selectedIndex)
            .value(
              this.currentMood
                ? `${this.formatTime(this.currentMood.date)} ${this.moodIcons[this.currentMood.moodType]} (${this.currentMood.moodScore}åˆ†)`
                : 'è¯·é€‰æ‹©'
            )
            .font({ size: 14 })
            .fontColor('#333')
            .selectedOptionFont({ size: 14 })
            .optionFont({ size: 14 })
            .onSelect((index: number) => {
              this.selectMood(index);
            })
            .layoutWeight(1)
            .margin({ left: 10 })
        }
        .width('90%')
        .padding(10)
        .backgroundColor('#F0F0F0')
        .borderRadius(8)
        .margin({ top: 10, bottom: 10 })
      } else {
        // å¦‚æœä»Šå¤©è¿˜æ²¡æ‰“å¡
        Column() {
          Text('âš ï¸ ä»Šå¤©è¿˜æ²¡æœ‰å¿ƒæƒ…æ‰“å¡').fontColor('#FF9800').fontSize(14)
          Text('è¯·å…ˆå»é¦–é¡µè®°å½•å¿ƒæƒ…ï¼Œå†æ¥å†™æ—¥è®°å…³è”å“¦~').fontColor('#999').fontSize(12).margin({ top: 5 })
        }
        .width('90%')
        .padding(15)
        .backgroundColor('#FFF3E0')
        .borderRadius(8)
        .margin({ top: 10, bottom: 10 })
      }

      // 3. ç¼–è¾‘åŒºåŸŸ
      Column() {
        TextArea({ text: this.diaryContent, placeholder: 'ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆå€¼å¾—è®°å½•çš„äº‹ï¼Ÿ...' })
          .height(300)
          .width('100%')
          .fontSize(16)
          .backgroundColor('transparent')
          .padding(15)
          .margin({ top: 10 })
          .onChange((value) => {
            this.diaryContent = value;
          })
          // å¦‚æœæ²¡é€‰å¿ƒæƒ…ï¼Œç¦ç”¨è¾“å…¥ï¼Œé˜²æ­¢æ•°æ®æ²¡åœ°å„¿å­˜
          .enabled(this.todayMoods.length > 0)
      }
      .width('90%')
      .layoutWeight(1)

    }
    .height('100%')
    .width('100%')
    .backgroundColor('#FFF')
  }

  saveDiary() {
    if (!this.currentMood) {
      AlertDialog.show({ message: 'è¯·å…ˆé€‰æ‹©ä¸€æ¡å¿ƒæƒ…è®°å½•æ¥å…³è”æ—¥è®°ï¼' });
      return;
    }

    // æ›´æ–°å½“å‰é€‰ä¸­çš„é‚£ä¸ª Mood å¯¹è±¡
    this.currentMood.diaryContent = this.diaryContent;
    // å›¾ç‰‡å­—æ®µé¢„ç•™ï¼Œæš‚ä¸æ›´æ–°

    // è°ƒç”¨æ•°æ®åº“æ›´æ–°
    MoodDB.update(this.currentMood).then(() => {
      AlertDialog.show({ message: 'âœ… æ—¥è®°ä¿å­˜æˆåŠŸ' });
      // å»¶è¿Ÿä¸€ç‚¹è¿”å›ï¼Œä½“éªŒæ›´å¥½
      setTimeout(() => {
        router.back();
      }, 500);
    }).catch((err: BusinessError) => {
      AlertDialog.show({ message: 'ä¿å­˜å¤±è´¥: ' + err.message });
    });
  }
}