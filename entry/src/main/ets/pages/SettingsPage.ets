import { router, promptAction } from '@kit.ArkUI';
import MoodDB from '../utils/MoodDB';

// åˆå§‹åŒ–æŒä¹…åŒ–å­˜å‚¨ï¼Œé»˜è®¤éšç§å¼€å…³æ˜¯å…³é—­çš„ (false)
PersistentStorage.persistProp('isPrivacyEnabled', false);

@Entry
@Component
struct SettingsPage {
  // ä¸æœ¬åœ°å­˜å‚¨åŒå‘ç»‘å®šï¼ŒApp é‡å¯åè¿˜åœ¨
  @StorageLink('isPrivacyEnabled') isPrivacyEnabled: boolean = false;

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Column() {
          Text('ğŸ‘ˆ').fontSize(24)
        }
        .width(40)
        .height(40)
        .justifyContent(FlexAlign.Center)
        .onClick(() => router.back())

        Text('è®¾ç½®')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Blank().width(40)
      }
      .width('100%')
      .padding({ top: 15, bottom: 15, left: 10, right: 10 })
      .backgroundColor('#FFFFFF')

      // 2. è®¾ç½®åˆ—è¡¨
      Column({ space: 15 }) {

        // --- åŠŸèƒ½ A: éšç§åŠ å¯†å¼€å…³ ---
        Row() {
          Column() {
            Text('éšç§ä¿æŠ¤æ¨¡å¼')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333')
            Text('å¼€å¯åï¼Œå¯åŠ¨Appéœ€è¦éªŒè¯èº«ä»½')
              .fontSize(12)
              .fontColor('#999')
              .margin({ top: 5 })
          }
          .alignItems(HorizontalAlign.Start)

          Toggle({ type: ToggleType.Switch, isOn: this.isPrivacyEnabled })
            .selectedColor('#7B61FF')
            .onChange((isOn: boolean) => {
              this.isPrivacyEnabled = isOn;
              // è¿™é‡Œå¯ä»¥åŠ ä¸€ä¸ªæç¤º
              if (isOn) {
                promptAction.showToast({ message: 'å·²å¼€å¯éšç§ä¿æŠ¤' });
              }
            })
        }
        .width('100%')
        .padding(15)
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .justifyContent(FlexAlign.SpaceBetween)

        // --- åŠŸèƒ½ B: æ¸…ç©ºæ•°æ® ---
        Row() {
          Text('æ¸…ç©ºæ‰€æœ‰æ—¥è®°æ•°æ®')
            .fontSize(16)
            .fontColor('#FF4444') // çº¢è‰²è­¦ç¤ºè‰²

          Text('ğŸ—‘ï¸').fontSize(20)
        }
        .width('100%')
        .padding(15)
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .justifyContent(FlexAlign.SpaceBetween)
        .onClick(() => {
          this.handleClearData();
        })

        // --- åŠŸèƒ½ C: é€€å‡ºç™»å½• ---
        Button('é€€å‡ºç™»å½•', { type: ButtonType.Normal })
          .width('100%')
          .height(50)
          .backgroundColor('#F5F5F5')
          .fontColor('#666')
          .borderRadius(16)
          .margin({ top: 30 })
          .onClick(() => {
            // 1. æ¸…é™¤å½“å‰ç”¨æˆ·çŠ¶æ€
            MoodDB.currentUserId = -1;
            // 2. è·³è½¬å›ç™»å½•é¡µ (ä¸å¯è¿”å›)
            router.replaceUrl({ url: 'pages/LoginPage' });
          })

      }
      .width('90%')
      .margin({ top: 20 })

      // åº•éƒ¨ç‰ˆæœ¬å·
      Blank()
      Text('Version 1.0.0')
        .fontSize(12)
        .fontColor('#CCC')
        .margin({ bottom: 20 })
    }
    .height('100%')
    .width('100%')
    .backgroundColor('#F5F7F9') // æµ…ç°èƒŒæ™¯
  }

  // å¤„ç†æ¸…ç©ºæ•°æ®çš„é€»è¾‘
  handleClearData() {
    AlertDialog.show({
      title: 'âš ï¸ å±é™©æ“ä½œ',
      message: 'ç¡®å®šè¦åˆ é™¤æ‰€æœ‰çš„å¿ƒæƒ…æ—¥è®°å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼',
      autoCancel: true,
      alignment: DialogAlignment.Bottom,
      offset: { dx: 0, dy: -20 },
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      },
      secondaryButton: {
        value: 'ç¡®è®¤åˆ é™¤',
        fontColor: '#FF0000',
        action: () => {
          MoodDB.clearUserData().then(() => {
            promptAction.showToast({ message: 'æ‰€æœ‰æ•°æ®å·²æ¸…ç©º' });
          });
        }
      }
    });
  }
}